<!DOCTYPE html>
<html>

<head>
    <meta charset='utf-8'>
    <meta http-equiv='X-UA-Compatible' content='IE=edge'>
    <title>sql</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-1BmE4kWBq78iYhFldvKuhfTAU6auU8tT94WrHftjDbrCEXSU1oBoqyl2QvZ6jIW3" crossorigin="anonymous">
    <script src="https://code.jquery.com/jquery-3.5.0.js"></script>

    <meta name='viewport' content='width=device-width, initial-scale=1'>
    <style>
        .alias {
            color: blue;
            font-weight: bold;
        }

        .operator {
            color: red;
        }

        table,
        th,
        td {
            border: 1px solid;
            padding: 5px;
        }
    </style>
    <script src='./bundle.js'></script>
</head>

<body>
    <div class="container">
        <div class="mt-5 row justify-content-center">
            <div class="col-2">
                <select onchange="change(event)">
                    <option value="1">diaries</option>
                    <option value="2">EAV</option>
                </select>
            </div>
        </div>
        <div class="row mt-5">
            <div class="col-6">
                <textarea id="sql" class="form-control" rows="20" aria-label="scss">SELECT * FROM DIARY D
JOIN ( SELECT P.DIARY_ID, MAX(P.ID) AS PID
FROM POSTS P
JOIN USERS U ON P.USER_ID = U.ID
GROUP BY P.DIARY_ID ) PP ON D.ID = PP.DIARY_ID
JOIN USERS U ON D.USER_ID = U.ID
ORDER BY PP.PID DESC</textarea>
            </div>
            <div class="col-6">
                <table class="main"></table>
            </div>
        </div>
        <div class="row error mt-5 d-flex justify-content-center">
        </div>
    </div>
    <div class="row">
        <div class="d-flex justify-content-center align-items-center ">
            <table class="res">
                <th>

                </th>

            </table>
        </div>
    </div>
</body>
<script>
    var num = {};
    var currAlias = [];
    let sql = document.querySelector('#sql');
    let main = document.querySelector('.main');

    let diary = {
        "POSTS": {
            col: ['ID', 'MSG', 'USER_ID', 'DIARY_ID'],
            data: [
                [1, "Мой блог о php", 1, 1],
                [2, "Как дела?", 2, 1],
                [3, "Мой уютный блог обо всем на свете", 2, 2],
                [4, "Сегодня хорошая погода", 2, 2],
            ],
        },
        "USERS": {
            col: ["ID", "LOGIN", "STATUS"],
            data: [
                [1, "admin", 1],
                [2, "user", 3],
            ]
        },
        "DIARY": {
            col: ["ID", "NAME", "USER_ID"],
            data: [
                [1, "php и рефлексия", 2],
                [2, "уютный бложик", 1],
                [3, "left join уютный бложик", 10],
            ]
        }
    };

    let eav = {
        "IBLOCK": {
            col: ['ID', 'NAME', 'PARENT_ID'],
            data: [
                [1, 'Каталог', 0],
                [2, 'Обувь', 1],
                [3, 'Тапочки', 2],
            ],
        },
        "IBLOCK_ELEMENTS": {
            col: ['ID', 'NAME', 'IBLOCK_ID'],
            data: [
                [1, 'Домашние Тапочки Розовый Рай', 3],
                [2, 'Домашние Тапочки Любимый Спорт', 3],
                [3, 'test group by', 3],

            ],
        },
        "IBLOCK_PROPERTIES": {
            col: ['ID', 'IS_NUMBER', 'IS_MULTY', 'NAME', 'IBLOCK_ID'],
            data: [
                [1, 0, 0, 'Артикул', 3],
                [2, 0, 0, 'Материал', 3],
            ],
        },
        "IBLOCK_PROP_VALUE": {
            col: ['ID', 'VALUE', 'VALUE_NUMBER', 'PROP_ID', 'EL_ID'],
            data: [
                [1, '174-15-xx', 0, 1, 1],
                [2, '174-16-xx', 0, 1, 2],
                [3, 'резина/кожа', 0, 2, 1],
                [4, 'текстиль/полимер', 0, 2, 2],
                [5, '174-15-xx', 0, 1, 3],
                [6, '174-15-xx', 0, 2, 3],
            ],
        },
    };
    let init = {};
    function change(event) {
        if (event) {
            mysql.table = event.target.value == "1" ? JSON.parse(JSON.stringify(diary)) : JSON.parse(JSON.stringify(eav));
            init = JSON.parse(JSON.stringify(mysql.table))
        }
        table();

    }
    let table = () => {
        let html = "";
        html += '<tr>'
        Object.keys(init).forEach((key) => {
            html += '<th>'
            html += key;
            html += '</th>'
        });
        html += '</tr>'
        let max = Math.max(...Object.values(init).map((c) => c.col?.length))
        for (let i = 0; i <= max - 1; i++) {
            html += '<tr>'
            for (let j = 0; j <= Object.keys(init).length - 1; j++) {
                html += `<td>${init[Object.keys(init)[j]]?.col[i] ?? ''}</td>`
            }
            html += '</tr>'

        }
        document.querySelector(".main").innerHTML = html
    }
    window.addEventListener("load", (event) => {
        table()
    });
    mysql.table = JSON.parse(JSON.stringify(diary))
    init = JSON.parse(JSON.stringify(mysql.table))
    table()

    //index

    let mainfn = (num) => {

        let res = (mysql.query(` ${sql.value} `));
        if (!res.length) {
            document.querySelector(".res").innerHTML = `<tr></tr>`
        }
        let html = "";
        html += '<tr>'
        Object.keys(res[0]).forEach((key) => {
            html += '<th>'
            html += key;
            html += '</th>'
        });
        html += '</tr>'

        res.forEach((c) => {
            html += '<tr>'
            Object.values(c).forEach((c) => {
                html += `<td>${c}</td>`
            })
            html += '</tr>'

        });
        document.querySelector(".res").innerHTML = html
    }
    var m = () => {

        try {
            num = $('textarea').prop("selectionStart");
            mainfn(num, 0, num);
            document.querySelector('.error').innerHTML = ``
        } catch (e) {
            document.querySelector(".res").innerHTML = ``
            document.querySelector('.error').innerHTML = `
                <div class="alert alert-danger d-flex align-items-center" role="alert">
                <svg class="bi flex-shrink-0 me-2" width="24" height="24" role="img" aria-label="Danger:"><use xlink:href="#exclamation-triangle-fill"/></svg>
                <div>
                    ${e}
                </div>
                </div>
                `;

        }
    };
    sql.addEventListener('keypress', m); // Every character written
    sql.addEventListener('input', m); // Other input events
    sql.addEventListener('paste', m); // Clipboard actions
    sql.addEventListener('cut', m);

    document.addEventListener("DOMContentLoaded", mainfn());


</script>

</html>